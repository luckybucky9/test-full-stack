# Chaud Issue Runner - Automatically work on GitHub issues
name: Chaud Issue Runner

on:
  issues:
    types: [opened]

jobs:
  trigger-chaud:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger chaud-cloud
        env:
          CHAUD_API_KEY: ${{ secrets.CHAUD_API_KEY }}
          CHAUD_CLOUD_URL: ${{ secrets.CHAUD_CLOUD_URL }}
          AUTO_MERGE: ${{ secrets.CHAUD_AUTO_MERGE }}
        run: |
          REQUEST_BODY=$(cat <<BODY
          {
            "repo_url": "${{ github.event.repository.clone_url }}",
            "issue_number": ${{ github.event.issue.number }},
            "issue_title": ${{ toJson(github.event.issue.title) }},
            "issue_body": ${{ toJson(github.event.issue.body) }},
            "repo_owner": "${{ github.repository_owner }}",
            "repo_name": "${{ github.event.repository.name }}",
            "auto_merge": ${AUTO_MERGE:-false}
          }
          BODY
          )

          curl -sf -X POST "${CHAUD_CLOUD_URL}/issue/work" \
            -H "Authorization: Bearer ${CHAUD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "${REQUEST_BODY}"

      - name: Add comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ”¥ **Chaud is working on this!** A PR will be created shortly.'
            });
